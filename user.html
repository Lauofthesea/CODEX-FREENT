<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Track Your Order - Lines Hub</title>
  <link rel="icon" type="image/jpg" href="./assets/lineslogo.jpg" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css-files/index.css">
  <link rel="stylesheet" href="./css-files/user-order.css">
  <link rel="stylesheet" href="./css-files/modals.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- All styles moved to user-order.css -->
</head>
<body>

  <div id="main-content">
    <header class="site-header">
      <div class="header-top">
        <div class="logo">
          <img src="./assets/lineslogo.jpg" alt="Lines Printing Services Logo" />
        </div>
      </div>
      <nav class="nav-wrapper">
        <ul class="main-nav">
          <li><a href="index.html">HOME</a></li>
          <li><a href="./pages/services.html">SERVICES</a></li>
          <li><a href="user.html">ORDERS</a></li>
          <li class="search-wrapper">
            <form class="search-form" onsubmit="handleSearch(event)">
              <div class="search-input-wrapper">
                <i class="fa fa-search search-icon"></i>
                <input type="text" id="search-input" placeholder="Search FREENT..." oninput="showSearchSuggestions(event)" />
              </div>
            </form>
            <div id="searchSuggestions" class="search-suggestions"></div>
          </li>
        </ul>
      </nav>
      <div class="header-actions">
        <div id="userIndicator" class="user-indicator" style="display: none;">
          <i class="fas fa-user-circle"></i>
          <span id="usernameDisplay">User</span>
        </div>
        <button id="loginBtn" class="cta login-btn" onclick="window.location.href='./pages/login.html'" style="display: block;">
          Login
        </button>
        <button id="accountBtn" class="cta login-btn" onclick="window.location.href='dashboard.html'" style="display: none;">
          Account
        </button>
      </div>
    </header>
  </div>

  <div class="tracking-container">
    <a href="dashboard.html" class="back-button">
      <i class="fas fa-arrow-left"></i>
      Back to Dashboard
    </a>

    <!-- Notifications Section -->
    <div class="notifications-card">
      <div class="notifications-header">
        <h2 class="notifications-title">
          <i class="fas fa-bell"></i>
          Notifications
          <span id="unreadBadge" class="notification-badge" style="display: none;">0</span>
        </h2>
        <button id="markAllReadBtn" class="mark-all-read" style="display: none;">
          <i class="fas fa-check-double"></i> Mark all as read
        </button>
      </div>
      <div id="notificationsList" class="notifications-list">
        <div class="no-notifications">
          <i class="fas fa-bell-slash"></i>
          <p>No notifications yet</p>
        </div>
      </div>
    </div>

    <div class="tracking-card">
      <h1 class="page-title">
        <i class="fas fa-search"></i> Track Your Order
      </h1>
      <p class="page-subtitle">Enter your order ID to check the status of your order</p>

      <!-- Search Section -->
      <div class="search-section">
        <label class="search-label" for="orderIdInput">
          <i class="fas fa-barcode"></i> Order ID
        </label>
        <div class="search-input-group">
          <input 
            type="text" 
            id="orderIdInput" 
            class="search-input" 
            placeholder="e.g., ORD-1234567890-ABCDE"
          >
          <button id="trackBtn" class="track-button">
              <i class="fas fa-search"></i> Track Order
            </button>

        </div>
      </div>

      <!-- Order Details Section (Hidden until searched) -->
      <div id="orderDetailsSection" style="display: none;">
        
        <!-- Order Info Card -->
        <div class="order-details-card">
          <h3>
            <i class="fas fa-info-circle"></i> Order Information
          </h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Order ID</span>
              <span class="detail-value" id="displayOrderId">-</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Product</span>
              <span class="detail-value" id="displayProduct">-</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Quantity</span>
              <span class="detail-value" id="displayQuantity">-</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Total Amount</span>
              <span class="detail-value highlight" id="displayTotal">‚Ç±0</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Order Date</span>
              <span class="detail-value" id="displayDate">-</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Payment Method</span>
              <span class="detail-value" id="displayPayment">-</span>
            </div>
          </div>
        </div>

        <!-- Status Timeline -->
        <div class="status-timeline">
  <h3 class="timeline-title">
    <i class="fas fa-clock"></i> Order Status Timeline
  </h3>
  <div class="horizontal-timeline">
    <div class="timeline-step" id="step-pending">
      <div class="timeline-icon">
        <i class="fas fa-clock"></i>
      </div>
      <div class="timeline-label">Order Received</div>
    </div>
    <div class="timeline-connector"></div>
    <div class="timeline-step" id="step-production">
      <div class="timeline-icon">
        <i class="fas fa-cogs"></i>
      </div>
      <div class="timeline-label">In Production</div>
    </div>
    <div class="timeline-connector"></div>
    <div class="timeline-step" id="step-delivery">
      <div class="timeline-icon">
        <i class="fas fa-truck"></i>
      </div>
      <div class="timeline-label">Out for Delivery</div>
    </div>
    <div class="timeline-connector"></div>
    <div class="timeline-step" id="step-delivered">
      <div class="timeline-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="timeline-label">Delivered / Complete</div>
    </div>
  </div>
</div>

      <!-- Order Not Found Message -->
      <div id="orderNotFound" class="order-not-found" style="display: none;">
        <i class="fas fa-search not-found-icon"></i>
        <h3 style="color: #fff; margin-bottom: 0.5rem; font-size: 1.5rem;">Order Not Found</h3>
        <p style="font-size: 1rem; margin-bottom: 1rem;">We couldn't find an order with that ID</p>
        <p style="font-size: 0.9rem;">Please check your Order ID and try again, or contact support if you need assistance.</p>
      </div>

    </div>
  </div>

  <footer class="site-footer">
    <div class="footer-content">
      <div class="footer-brand">
        <img src="./assets/lineslogo.jpg" alt="Lines Printing Services Logo" />
        <p>Lines Printing Services<br />Your Freedom to Print</p>
      </div>

      <div class="footer-links">
        <a href="index.html">Home</a>
        <a href="./pages/services.html">Services</a>
        <a href="dashboard.html">My Account</a>
        <a href="#">Contact</a>
      </div>

      <div class="footer-contact">
        <p>üìç E. Locson Drive, Talon-talon, Zamboanga City</p>
        <p>üìû - - - - - </p>
        <p>üìß linesprintingservices@gmail.com</p>
      </div>
    </div>

    <div class="footer-bottom">
      <p>&copy; 2025 Lines Printing Services. All rights reserved.</p>
    </div>
  </footer>

  <script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, onSnapshot, orderBy, updateDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAao4TBFvMR099d5sEfvX1I65d0LCAJUZw",
    authDomain: "lineshub-98e0f.firebaseapp.com",
    projectId: "lineshub-98e0f",
    storageBucket: "lineshub-98e0f.appspot.com",
    messagingSenderId: "427905073524",
    appId: "1:427905073524:web:95cb66ffeabf011087ec21"
  };

  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Check login status and update navigation
  function updateNavigation() {
    const userLoggedIn = sessionStorage.getItem('userLoggedIn');
    const username = sessionStorage.getItem('username') || 'User';
    
    if (userLoggedIn === 'true') {
      document.getElementById('userIndicator').style.display = 'flex';
      document.getElementById('usernameDisplay').textContent = username;
      document.getElementById('accountBtn').style.display = 'block';
      document.getElementById('loginBtn').style.display = 'none';
    } else {
      document.getElementById('userIndicator').style.display = 'none';
      document.getElementById('accountBtn').style.display = 'none';
      document.getElementById('loginBtn').style.display = 'block';
    }
  }

  updateNavigation();

  // ========== NOTIFICATIONS SYSTEM ==========
  function loadNotifications() {
    const userEmail = sessionStorage.getItem('userEmail');
    if (!userEmail) return;

    const notificationsQuery = query(
      collection(db, "notifications"),
      where("userId", "==", userEmail),
      orderBy("timestamp", "desc")
    );

    onSnapshot(notificationsQuery, (snapshot) => {
      const notificationsList = document.getElementById('notificationsList');
      const unreadBadge = document.getElementById('unreadBadge');
      const markAllReadBtn = document.getElementById('markAllReadBtn');
      
      if (snapshot.empty) {
        notificationsList.innerHTML = `
          <div class="no-notifications">
            <i class="fas fa-bell-slash"></i>
            <p>No notifications yet</p>
          </div>
        `;
        unreadBadge.style.display = 'none';
        markAllReadBtn.style.display = 'none';
        return;
      }

      let unreadCount = 0;
      let html = '';

      snapshot.forEach(docSnap => {
        const notif = docSnap.data();
        const notifId = docSnap.id;
        const isUnread = !notif.read;
        
        if (isUnread) unreadCount++;

        const timeAgo = getTimeAgo(notif.timestamp);
        const icon = getNotificationIcon(notif.type);

        html += `
          <div class="notification-item ${isUnread ? 'unread' : ''}" onclick="markAsRead('${notifId}')">
            <div class="notification-header-row">
              <div class="notification-title">
                <i class="${icon}"></i>
                ${notif.title}
              </div>
              <div class="notification-time">${timeAgo}</div>
            </div>
            <div class="notification-message">${notif.message}</div>
            ${notif.orderId ? `<div class="notification-order-id">Order: ${notif.orderId}</div>` : ''}
          </div>
        `;
      });

      notificationsList.innerHTML = html;

      if (unreadCount > 0) {
        unreadBadge.textContent = unreadCount;
        unreadBadge.style.display = 'inline-block';
        markAllReadBtn.style.display = 'block';
      } else {
        unreadBadge.style.display = 'none';
        markAllReadBtn.style.display = 'none';
      }
    });
  }

  function getNotificationIcon(type) {
    const icons = {
      'order_submitted': 'fas fa-check-circle',
      'order_updated': 'fas fa-sync-alt',
      'order_completed': 'fas fa-check-double',
      'price_updated': 'fas fa-dollar-sign'
    };
    return icons[type] || 'fas fa-bell';
  }

  function getTimeAgo(timestamp) {
    try {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);

      if (diff < 60) return 'Just now';
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
      if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
      return date.toLocaleDateString();
    } catch (e) {
      return '';
    }
  }

  window.markAsRead = async function(notifId) {
    try {
      await updateDoc(doc(db, "notifications", notifId), {
        read: true
      });
    } catch (error) {
      console.error("Error marking notification as read:", error);
    }
  };

  window.markAllAsRead = async function() {
    const userEmail = sessionStorage.getItem('userEmail');
    if (!userEmail) return;

    try {
      const notificationsQuery = query(
        collection(db, "notifications"),
        where("userId", "==", userEmail),
        where("read", "==", false)
      );

      const snapshot = await getDocs(notificationsQuery);
      const batch = writeBatch(db);

      snapshot.forEach(docSnap => {
        batch.update(doc(db, "notifications", docSnap.id), { read: true });
      });

      await batch.commit();
    } catch (error) {
      console.error("Error marking all as read:", error);
    }
  };

  // Load notifications on page load
  loadNotifications();

  // Add event listener for mark all read button
  document.getElementById('markAllReadBtn').addEventListener('click', markAllAsRead);

  // Define trackOrder BEFORE using it
  window.trackOrder = async function trackOrder() {
    const orderId = document.getElementById('orderIdInput').value.trim();
    if (!orderId) {
      showErrorModal('Missing Information', 'Please enter an Order ID to track your order.');
      return;
    }

    try {
      const ordersRef = collection(db, "orders");
      const q = query(ordersRef, where("orderId", "==", orderId));
      const querySnapshot = await getDocs(q);

      if (querySnapshot.empty) {
        document.getElementById('orderDetailsSection').style.display = 'none';
        document.getElementById('orderNotFound').style.display = 'block';
        return;
      }

      const orderData = querySnapshot.docs[0].data();
      document.getElementById('orderNotFound').style.display = 'none';
      document.getElementById('orderDetailsSection').style.display = 'block';

      document.getElementById('displayOrderId').textContent = orderData.orderId;
      document.getElementById('displayProduct').textContent = orderData.product;
      document.getElementById('displayQuantity').textContent = orderData.quantity;
      document.getElementById('displayTotal').textContent = '‚Ç±' + (orderData.total || 0).toFixed(2);
      document.getElementById('displayDate').textContent = orderData.date || '-';
      document.getElementById('displayPayment').textContent = orderData.paymentMethod?.toUpperCase() || '-';

      updateStatusTimeline(orderData.status);
      document.getElementById('orderDetailsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    } catch (error) {
      console.error("Error tracking order:", error);
      showErrorModal('Error', 'Error tracking order. Please try again.');
    }
  };

  // Now check URL params and call trackOrder if needed
  const urlParams = new URLSearchParams(window.location.search);
  const orderIdFromUrl = urlParams.get('orderId');
  if (orderIdFromUrl) {
    document.getElementById('orderIdInput').value = orderIdFromUrl;
    trackOrder();  // This will now work since trackOrder is defined above
  }

  function updateStatusTimeline(status) {
    // Reset all steps
    const steps = ['step-pending', 'step-production', 'step-delivery', 'step-delivered'];
    steps.forEach(step => {
      const element = document.getElementById(step);
      element.classList.remove('active', 'completed');
    });

    // Map status to steps
    const statusMap = {
      'Pending': ['step-pending'],
      'On Production': ['step-pending', 'step-production'],
      'On Delivery': ['step-pending', 'step-production', 'step-delivery'],
      'Delivered': ['step-pending', 'step-production', 'step-delivery', 'step-delivered'],
      'Complete': ['step-pending', 'step-production', 'step-delivery', 'step-delivered']
    };

    const activeSteps = statusMap[status] || ['step-pending'];
    
    // Mark completed steps
    for (let i = 0; i < activeSteps.length - 1; i++) {
      document.getElementById(activeSteps[i]).classList.add('completed');
    }
    
    // Mark current active step
    const currentStep = activeSteps[activeSteps.length - 1];
    document.getElementById(currentStep).classList.add('active');
  }

  // Allow Enter key to track
  document.getElementById('orderIdInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      trackOrder();
    }
  });

  document.getElementById("trackBtn").addEventListener("click", trackOrder);

  // Search data
  const searchData = [
    { name: 'Document Printing', category: 'Service', icon: 'fas fa-file-alt', url: './pages/services.html#document' },
    { name: 'Photo Printing', category: 'Service', icon: 'fas fa-image', url: './pages/services.html#photo' },
    { name: 'Shirt Printing', category: 'Service', icon: 'fas fa-tshirt', url: './pages/services.html#shirt' },
    { name: 'Tarpaulin Printing', category: 'Service', icon: 'fas fa-rectangle-ad', url: './pages/services.html#tarpaulin' },
    { name: 'Signages', category: 'Service', icon: 'fas fa-sign', url: './pages/services.html#signages' },
    { name: 'Stickers', category: 'Service', icon: 'fas fa-sticky-note', url: './pages/services.html#stickers' },
    { name: 'Gift Boxes', category: 'Service', icon: 'fas fa-gift', url: './pages/services.html#gifts' },
    { name: 'Lanyards', category: 'Service', icon: 'fas fa-id-badge', url: './pages/services.html#lanyards' },
    { name: 'Invitations', category: 'Service', icon: 'fas fa-envelope', url: './pages/services.html#invitations' },
    { name: 'Customized Items', category: 'Service', icon: 'fas fa-magic', url: './pages/services.html#customized' },
    { name: 'Dashboard', category: 'Page', icon: 'fas fa-tachometer-alt', url: '../dashboard.html' },
    { name: 'Services', category: 'Page', icon: 'fas fa-concierge-bell', url: './pages/services.html' },
    { name: 'Home', category: 'Page', icon: 'fas fa-home', url: '../index.html' }
  ];

  // Show search suggestions
  window.showSearchSuggestions = function(event) {
    const query = event.target.value.trim().toLowerCase();
    const suggestionsDiv = document.getElementById('searchSuggestions');
    
    if (!suggestionsDiv) return;
    
    if (query.length === 0) {
      suggestionsDiv.classList.remove('active');
      return;
    }

    const filtered = searchData.filter(item => 
      item.name.toLowerCase().includes(query) || 
      item.category.toLowerCase().includes(query)
    );

    if (filtered.length === 0) {
      suggestionsDiv.innerHTML = '<div class="no-results">No results found</div>';
      suggestionsDiv.classList.add('active');
      return;
    }

    suggestionsDiv.innerHTML = filtered.map(item => `
      <div class="suggestion-item" onclick="navigateToSuggestion('${item.url}')">
        <i class="${item.icon}"></i>
        <span class="suggestion-text">${item.name}</span>
        <span class="suggestion-category">${item.category}</span>
      </div>
    `).join('');
    
    suggestionsDiv.classList.add('active');
  };

  // Navigate to suggestion
  window.navigateToSuggestion = function(url) {
    window.location.href = url;
  };

  // Handle search
  window.handleSearch = function(event) {
    event.preventDefault();
    const query = document.getElementById('search-input').value.trim();
    if (query) {
      window.location.href = `./pages/services.html?search=${encodeURIComponent(query)}`;
    }
  };

  // Close suggestions when clicking outside
  document.addEventListener('click', function(event) {
    const searchWrapper = document.querySelector('.search-wrapper');
    const suggestionsDiv = document.getElementById('searchSuggestions');
    if (searchWrapper && suggestionsDiv && !searchWrapper.contains(event.target)) {
      suggestionsDiv.classList.remove('active');
    }
  });
</script>

<script src="./js-files/modals.js"></script>
</body>
</html>