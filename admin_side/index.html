<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lines Hub Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../css-files/admin-dashboard.css">
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar">
  <div class="navbar-brand">
    <img src="https://via.placeholder.com/40" class="navbar-logo" alt="Logo">
    <span class="navbar-title">Lines Hub</span>
  </div>

  <div class="navbar-menu">
    <button onclick="showSection('dashboardSection')" id="dashboardBtn" class="nav-btn nav-btn-active">Dashboard</button>
    <button onclick="showSection('ordersSection')" id="ordersBtn" class="nav-btn nav-btn-inactive">Orders</button>
    <button onclick="showSection('historySection')" id="historyBtn" class="nav-btn nav-btn-inactive">Transaction History</button>
    <button onclick="showSection('messagesSection')" id="messagesBtn" class="nav-btn nav-btn-inactive">Messages</button>
  </div>

  <button class="logout-btn">Logout</button>
</nav>

<!-- PAGE TITLE -->
<header class="page-header">
  <h1 id="pageTitle" class="page-title">Dashboard</h1>
</header>

<main class="main-content">

<!-- ========== DASHBOARD SECTION ========== -->
<div id="dashboardSection">

  <!-- KPI CARDS -->
  <div class="kpi-grid">

    <div class="kpi-card">
      <p class="kpi-label">Total Orders Today</p>
      <p id="totalOrdersToday" class="kpi-value">0</p>
    </div>

    <div class="kpi-card yellow">
      <p class="kpi-label">Pending Orders</p>
      <p id="pendingOrders" class="kpi-value">0</p>
    </div>

    <div class="kpi-card green">
      <p class="kpi-label">Revenue Today</p>
      <p id="revenueToday" class="kpi-value">₱0</p>
    </div>

  </div>

  <!-- RECENT ORDERS TABLE -->
  <div class="table-container">
    <h2 class="table-header">Recent Orders</h2>

    <table class="data-table">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Product</th>
          <th>Qty</th>
          <th>Type</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="dashboardOrdersBody"></tbody>
    </table>
  </div>

</div>


<!-- ========== ORDERS SECTION ========== -->
<div id="ordersSection" class="hidden">

  <!-- Tabs -->
  <div class="filter-tabs">
    <button onclick="filterOrdersByType('all')" id="tabAll" class="tab-btn tab-btn-active">All</button>
    <button onclick="filterOrdersByType('recent')" id="tabRecent" class="tab-btn tab-btn-inactive">Recent</button>
    <button onclick="filterOrdersByType('pending')" id="tabPending" class="tab-btn tab-btn-inactive">Pending</button>
  </div>

  <!-- Search & Sort -->
  <div class="controls-row">
    <input id="orderSearch" type="text" placeholder="Search orders..." class="search-input" onkeyup="filterOrders()">

    <select id="orderSort" class="sort-select" onchange="sortOrders()">
      <option value="">Sort By</option>
      <option value="dateAsc">Date ↑ (Oldest)</option>
      <option value="dateDesc">Date ↓ (Newest)</option>
      <option value="qtyAsc">Quantity ↑</option>
      <option value="qtyDesc">Quantity ↓</option>
      <option value="status">Status</option>
    </select>
  </div>

  <!-- Orders Table -->
  <div class="table-container">
    <table id="ordersTable" class="data-table">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Product</th>
          <th>Qty</th>
          <th>Type</th>
          <th>Status</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="ordersBody"></tbody>
    </table>
  </div>

</div>


<!-- ========== TRANSACTION HISTORY ========== -->
<div id="historySection" class="hidden">
  <div class="table-container">

    <table class="data-table">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Product</th>
          <th>Qty</th>
          <th>Type</th>
          <th>Status</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>

  </div>
</div>


<!-- ========== MESSAGES SECTION ========== -->
<div id="messagesSection" class="hidden">
  <div class="table-container">
    <h2 class="table-header">Messages</h2>
    <p style="color: #6b7280;">Messaging system coming soon...</p>
  </div>
</div>


<!-- ========== ORDER DETAILS MODAL ========== -->
<div id="orderModal" class="modal-overlay hidden">
  <div class="modal-content">

    <button onclick="closeOrderModal()" class="modal-close-btn">&times;</button>

    <h2 class="modal-title">Order Details</h2>

    <div id="orderDetailsContent" class="modal-details"></div>

  </div>
</div>



<!-- ========== JAVASCRIPT ========== -->
<script type="module">

/* Import Firebase init */
import { db } from "./firebase-init.js";
import { collection, onSnapshot, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const ordersCol = collection(db, "orders");

/* Make all needed functions global */
window.showSection = showSection;
window.closeOrderModal = closeOrderModal;
window.showOrderDetails = showOrderDetails;
window.updateStatus = updateStatus;
window.filterOrdersByType = filterOrdersByType;
window.filterOrders = filterOrders;
window.sortOrders = sortOrders;


/* ========== SECTION SWITCHING ========== */
function showSection(id) {
  const sections = ["dashboardSection","ordersSection","historySection","messagesSection"];
  const nav = {
    dashboardSection:"dashboardBtn",
    ordersSection:"ordersBtn",
    historySection:"historyBtn",
    messagesSection:"messagesBtn"
  };

  sections.forEach(s => document.getElementById(s).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");

  const titles = {
    dashboardSection:"Dashboard",
    ordersSection:"Orders",
    historySection:"Transaction History",
    messagesSection:"Messages"
  };
  document.getElementById("pageTitle").innerText = titles[id];

  Object.keys(nav).forEach(sec => {
    const btn = document.getElementById(nav[sec]);
    if(sec === id){
      btn.className = "nav-btn nav-btn-active";
    } else {
      btn.className = "nav-btn nav-btn-inactive";
    }
  });
}


/* ========== CLOSE MODAL ========== */
function closeOrderModal() {
  document.getElementById("orderModal").classList.add("hidden");
}


/* ========== LOAD ORDERS LIVE FROM FIRESTORE ========== */
const dashboardOrdersBody = document.getElementById("dashboardOrdersBody");
const ordersBody = document.getElementById("ordersBody");
const historyBody = document.getElementById("historyBody");

onSnapshot(ordersCol, (snapshot) => {

  dashboardOrdersBody.innerHTML = "";
  ordersBody.innerHTML = "";
  historyBody.innerHTML = "";

  let totalOrders = 0;
  let pendingOrders = 0;
  let revenue = 0;

  snapshot.forEach(docSnap => {
    const order = docSnap.data();
    order.docId = docSnap.id;

    totalOrders++;

    if(order.status.toLowerCase() === "pending") pendingOrders++;
    if(["delivered","complete"].includes(order.status.toLowerCase()))
      revenue += order.total || 0;

    const row = `
      <tr onclick="showOrderDetails('${order.docId}')">
        <td>${order.orderId}</td>
        <td>${order.customer}</td>
        <td>${order.product}</td>
        <td>${order.quantity}</td>
        <td>${order.type || "-"}</td>
        <td>${order.status}</td>
      </tr>
    `;

    dashboardOrdersBody.innerHTML += row;
    ordersBody.innerHTML += `
      <tr onclick="showOrderDetails('${order.docId}')">
        <td>${order.orderId}</td>
        <td>${order.customer}</td>
        <td>${order.product}</td>
        <td>${order.quantity}</td>
        <td>${order.type || "-"}</td>
        <td>${order.status}</td>
        <td>${order.date || "-"}</td>
      </tr>
    `;

    if(["delivered","complete"].includes(order.status.toLowerCase())){
      historyBody.innerHTML += `
        <tr>
          <td>${order.orderId}</td>
          <td>${order.customer}</td>
          <td>${order.product}</td>
          <td>${order.quantity}</td>
          <td>${order.type || "-"}</td>
          <td>${order.status}</td>
          <td>${order.date || "-"}</td>
        </tr>
      `;
    }

  });

  document.getElementById("totalOrdersToday").innerText = totalOrders;
  document.getElementById("pendingOrders").innerText = pendingOrders;
  document.getElementById("revenueToday").innerText = "₱" + revenue;

});


/* ========== ORDER DETAILS MODAL ========== */
async function showOrderDetails(id) {
  const snap = await getDoc(doc(db, "orders", id));
  const order = snap.data();

  document.getElementById("orderDetailsContent").innerHTML = `
    <p><strong>Order ID:</strong> ${order.orderId}</p>
    <p><strong>Customer:</strong> ${order.customer}</p>
    <p><strong>Contact:</strong> ${order.contact || "-"}</p>
    <p><strong>Email:</strong> ${order.email || "-"}</p>

    <hr class="modal-divider">

    <p><strong>Product:</strong> ${order.product}</p>
    <p><strong>Type:</strong> ${order.type || "-"}</p>
    <p><strong>Size:</strong> ${order.size || "-"}</p>
    <p><strong>Height:</strong> ${order.height || "-"} cm</p>
    <p><strong>Width:</strong> ${order.width || "-"} cm</p>

    <hr class="modal-divider">

    <p><strong>Quantity:</strong> ${order.quantity}</p>
    <p><strong>Price per item:</strong> ₱${order.price || 0}</p>
    <p><strong>Total Price:</strong> <span class="price-highlight">₱${order.total || 0}</span></p>

    <hr class="modal-divider">

    <p><strong>Notes:</strong> ${order.notes || "-"}</p>

    <hr class="modal-divider">

    <p><strong>Status:</strong>
      <select id="statusSelect" class="status-select">
        <option ${order.status==="Pending"?"selected":""}>Pending</option>
        <option ${order.status==="On Production"?"selected":""}>On Production</option>
        <option ${order.status==="On Delivery"?"selected":""}>On Delivery</option>
        <option ${order.status==="Delivered"?"selected":""}>Delivered</option>
        <option ${order.status==="Complete"?"selected":""}>Complete</option>
      </select>

      <button onclick="updateStatus('${id}')" class="update-btn">
        Update
      </button>
    </p>

    <p><strong>Date:</strong> ${order.date || "-"}</p>
  `;

  document.getElementById("orderModal").classList.remove("hidden");
}



/* ========== UPDATE ORDER STATUS ========== */
async function updateStatus(id) {
  const status = document.getElementById("statusSelect").value;
  await updateDoc(doc(db, "orders", id), { status });
  closeOrderModal();
}


/* ========== FILTER BY TYPE ========== */
function filterOrdersByType(type) {
  const rows = [...document.querySelectorAll("#ordersTable tbody tr")];

  rows.forEach(r => r.style.display = "none");

  let filtered = rows;

  if(type === "pending")
    filtered = rows.filter(r => r.cells[5].innerText.toLowerCase() === "pending");

  if(type === "recent") {
    const today = new Date();
    filtered = rows.filter(row => {
      const d = new Date(row.cells[6].innerText);
      return (today - d) / (1000 * 60 * 60 * 24) <= 7;
    });
  }

  if(type === "all")
    filtered = rows;

  filtered.forEach(r => r.style.display = "");

  // Update tab styling
  ["tabAll","tabRecent","tabPending"].forEach(id => {
    const btn = document.getElementById(id);
    btn.className = "tab-btn tab-btn-inactive";
  });

  const tab = { all:"tabAll", recent:"tabRecent", pending:"tabPending" }[type];
  const btn = document.getElementById(tab);
  btn.className = "tab-btn tab-btn-active";
}


/* ========== SEARCH ========== */
function filterOrders() {
  const q = document.getElementById("orderSearch").value.toLowerCase();
  const rows = document.querySelectorAll("#ordersTable tbody tr");

  rows.forEach(r => {
    r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none";
  });
}


/* ========== SORTING (INCLUDES DATE) ========== */
function sortOrders() {
  const sort = document.getElementById("orderSort").value;
  const table = document.getElementById("ordersTable").tBodies[0];
  const rows = [...table.rows];

  rows.sort((a, b) => {

    // Sort by date ASC
    if(sort === "dateAsc") {
      return new Date(a.cells[6].innerText) - new Date(b.cells[6].innerText);
    }

    // Sort by date DESC
    if(sort === "dateDesc") {
      return new Date(b.cells[6].innerText) - new Date(a.cells[6].innerText);
    }

    // Sort by quantity
    if(sort === "qtyAsc") return a.cells[3].innerText - b.cells[3].innerText;
    if(sort === "qtyDesc") return b.cells[3].innerText - a.cells[3].innerText;

    // Sort by status
    if(sort === "status") return a.cells[5].innerText.localeCompare(b.cells[5].innerText);

    return 0;
  });

  rows.forEach(r => table.appendChild(r));
}

</script>
</body>
</html>